{% extends "layout.html" %}

{% block title %}STT í…ŒìŠ¤íŠ¸ (íŒŒì´í”„ë¼ì¸ - ì˜¤ë””ì˜¤){% endblock %}

{% block content %}
<main class="content-panel">
    <header class="content-header">
        <h1>STT í…ŒìŠ¤íŠ¸ (íŒŒì´í”„ë¼ì¸ - ì˜¤ë””ì˜¤)</h1>
        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">ì˜¤ë””ì˜¤ â†’ STT â†’ ìš”ì•½ â†’ ë§ˆì¸ë“œë§µ</p>
    </header>

    <div style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
        <!-- íŒŒì¼ ì—…ë¡œë“œ -->
        <form id="stt-form" enctype="multipart/form-data">
            <div class="form-group">
                <label for="audio-file-input">ì˜¤ë””ì˜¤ íŒŒì¼ ì„ íƒ</label>
                <div class="drop-zone" id="drop-zone" style="border: 2px dashed #ddd; border-radius: 8px; padding: 3rem; text-align: center; cursor: pointer; transition: all 0.3s ease;">
                    <input type="file" id="audio-file-input" name="audio_file" accept=".wav,.mp3,.m4a,.flac,.mp4" style="display: none;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸµ</div>
                    <p style="margin: 0.5rem 0;">ìŒì„± íŒŒì¼ì„ ëŒì–´ë†“ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</p>
                    <button type="button" class="btn-secondary" id="select-file-btn" style="margin-top: 1rem; padding: 0.75rem 2rem;">íŒŒì¼ ì„ íƒ</button>
                    <p id="file-name-display" style="margin-top: 1rem; font-weight: 600; color: #3498db;"></p>
                    <p style="font-size: 0.85rem; color: #999; margin-top: 0.5rem;">(ì§€ì›: .wav, .mp3, .m4a, .flac, .mp4)</p>
                </div>
            </div>

            <!-- ë²„íŠ¼ -->
            <div style="margin-top: 1.5rem; text-align: center;">
                <button type="submit" id="transcribe-btn" class="btn-primary" style="padding: 0.75rem 3rem; font-size: 1rem;" disabled>ìŒì„± ì¸ì‹ ì‹œì‘</button>
            </div>
        </form>

        <!-- ë¡œë”© -->
        <div id="loading-section" style="margin-top: 3rem; text-align: center; display: none;">
            <div class="spinner" style="margin: 2rem auto; width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="color: #666; font-size: 1.1rem;">ìŒì„±ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ìµœëŒ€ ìˆ˜ ë¶„)</p>
        </div>

        <!-- ê²°ê³¼ -->
        <div id="result-section" style="margin-top: 3rem; display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 style="margin: 0;">ìŒì„± ì¸ì‹ ê²°ê³¼</h2>
                <button id="copy-btn" class="btn-secondary" style="padding: 0.5rem 1.5rem;">ë³µì‚¬</button>
            </div>
            <div id="result-content" style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 2rem; white-space: pre-wrap; font-family: 'Pretendard', -apple-system, sans-serif; line-height: 1.8; max-height: 500px; overflow-y: auto;"></div>

            <!-- ë‹¤ìŒ ë‹¨ê³„ ë²„íŠ¼ -->
            <div style="margin-top: 1.5rem; text-align: center; padding: 1.5rem; background: #e3f2fd; border-radius: 8px;">
                <p style="margin: 0 0 1rem 0; font-weight: 600; color: #1976d2;">âœ… ìŒì„± ì¸ì‹ ì™„ë£Œ! ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•˜ì„¸ìš”</p>
                <button id="next-summary-btn" class="btn-primary" style="padding: 0.75rem 3rem; font-size: 1rem;">ìš”ì•½ ìƒì„±í•˜ê¸° â†’</button>
            </div>
        </div>
    </div>
</main>

<script>
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('audio-file-input');
const fileNameDisplay = document.getElementById('file-name-display');
const selectFileBtn = document.getElementById('select-file-btn');
const transcribeBtn = document.getElementById('transcribe-btn');
const sttForm = document.getElementById('stt-form');

// íŒŒì¼ ì„ íƒ ë²„íŠ¼
selectFileBtn.addEventListener('click', () => {
    fileInput.click();
});

// ë“œë¡­ì¡´ í´ë¦­
dropZone.addEventListener('click', (e) => {
    if (e.target !== selectFileBtn) {
        fileInput.click();
    }
});

// íŒŒì¼ ì„ íƒ
fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        fileNameDisplay.textContent = `ì„ íƒëœ íŒŒì¼: ${file.name}`;
        transcribeBtn.disabled = false;
        dropZone.style.borderColor = '#3498db';
        dropZone.style.background = '#f0f8ff';
    }
});

// ë“œë˜ê·¸ ì•¤ ë“œë¡­
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#3498db';
    dropZone.style.background = '#f0f8ff';
});

dropZone.addEventListener('dragleave', () => {
    dropZone.style.borderColor = '#ddd';
    dropZone.style.background = 'transparent';
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    const file = e.dataTransfer.files[0];
    if (file) {
        fileInput.files = e.dataTransfer.files;
        fileNameDisplay.textContent = `ì„ íƒëœ íŒŒì¼: ${file.name}`;
        transcribeBtn.disabled = false;
        dropZone.style.borderColor = '#3498db';
        dropZone.style.background = '#f0f8ff';
    }
});

// í¼ ì œì¶œ
sttForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (fileInput.files.length === 0) {
        alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    // ë¡œë”© í‘œì‹œ
    document.getElementById('result-section').style.display = 'none';
    document.getElementById('loading-section').style.display = 'block';
    transcribeBtn.disabled = true;

    const formData = new FormData();
    formData.append('audio_file', fileInput.files[0]);

    try {
        const response = await fetch('/api/test_stt', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('result-content').textContent = data.transcript_text;
            document.getElementById('result-section').style.display = 'block';

            // sessionStorageì— ì €ì¥ (ë‹¤ìŒ ë‹¨ê³„ë¡œ ì „ë‹¬)
            sessionStorage.setItem('pipeline_stt_result', data.transcript_text);
            sessionStorage.setItem('pipeline_step', 'stt');

            console.log('âœ… STT ê²°ê³¼ ì €ì¥:', data.transcript_text.substring(0, 100) + '...');
        } else {
            alert('ìŒì„± ì¸ì‹ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            transcribeBtn.disabled = false;
        }
    } catch (error) {
        console.error('STT ì˜¤ë¥˜:', error);
        alert('ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        transcribeBtn.disabled = false;
    } finally {
        document.getElementById('loading-section').style.display = 'none';
    }
});

// ë³µì‚¬ ë²„íŠ¼
document.getElementById('copy-btn').addEventListener('click', () => {
    const content = document.getElementById('result-content').textContent;
    navigator.clipboard.writeText(content).then(() => {
        alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }).catch(err => {
        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
});

// ë‹¤ìŒ ë‹¨ê³„ (ìš”ì•½) ë²„íŠ¼
document.getElementById('next-summary-btn').addEventListener('click', () => {
    window.location.href = '/test-summary';
});
</script>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
}
</style>
{% endblock %}
