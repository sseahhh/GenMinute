
{% extends "layout.html" %}

{% block title %}모든 노트{% endblock %}

{% block content %}
<main class="content-panel">
    <div class="viewer-container"> {# viewer-container 스타일 재사용 #}
        <header class="viewer-header notes-header">
            <h1>모든 노트</h1>
            <div class="header-controls">
                <div class="sort-controls">
                    <label for="sort-select">정렬:</label>
                    <select id="sort-select" class="sort-select">
                        <option value="date-desc">날짜 (최신순)</option>
                        <option value="date-asc">날짜 (오래된순)</option>
                        <option value="title-asc">제목 (가나다순)</option>
                        <option value="title-desc">제목 (가나다 역순)</option>
                    </select>
                </div>
                <div class="bulk-actions">
                    <button id="share-btn" class="btn-outline" disabled>공유</button>
                    <button id="select-all-btn" class="btn-outline" disabled>모두선택</button>
                    <button id="bulk-delete-btn" class="btn-outline" disabled>삭제</button>
                </div>
            </div>
        </header>

        <div class="notes-list">
            {% if meetings %}
                {% for meeting in meetings %}
                    <div class="note-item-wrapper">
                        <input type="checkbox"
                               class="note-checkbox"
                               data-meeting-id="{{ meeting.meeting_id }}"
                               data-title="{{ meeting.title }}"
                               data-audio-file="{{ meeting.audio_file }}">
                        <a href="{{ url_for('meetings.view_meeting', meeting_id=meeting.meeting_id) }}" class="note-item">
                            <div class="note-item-title">{{ meeting.title }}</div>
                            <div class="note-item-date">{{ meeting.date }}</div>
                        </a>
                    </div>
                {% endfor %}
            {% else %}
                <p>저장된 노트가 없습니다.</p>
            {% endif %}
        </div>
    </div>

    <!-- 삭제 확인 모달 -->
    <div id="delete-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>노트 삭제</h2>
            <p id="delete-message">정말로 이 노트를 삭제하시겠습니까?</p>
            <p style="color: #888; font-size: 0.9rem; margin-top: 0.5rem;">
                ⚠️ 오디오 파일, 스크립트, 청킹된 텍스트, 문단 요약, 회의록을 포함한 모든 데이터가 삭제됩니다.
            </p>
            <div class="modal-buttons">
                <button id="confirm-delete-btn" class="btn-danger">예</button>
                <button id="cancel-delete-btn" class="btn-secondary">아니오</button>
            </div>
        </div>
    </div>

    <!-- 공유 모달 -->
    <div id="share-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>노트 공유</h2>
            <p id="share-message">선택한 노트를 공유할 이메일을 입력하세요.</p>
            <input type="email" id="share-email-input" class="share-email-input" placeholder="example@email.com">
            <div class="modal-buttons">
                <button id="confirm-share-btn" class="btn-primary">공유</button>
                <button id="cancel-share-btn" class="btn-secondary">취소</button>
            </div>
        </div>
    </div>
</main>

<style>
/* 헤더 스타일 */
.notes-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notes-header h1 {
    margin: 0;
}

/* 헤더 컨트롤 */
.header-controls {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

/* 정렬 컨트롤 */
.sort-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sort-controls label {
    font-size: 1rem;
    color: #555;
    white-space: nowrap;
}

.sort-select {
    padding: 0.5rem 1rem;
    border: 2px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    background: white;
    transition: border-color 0.2s ease;
}

.sort-select:hover {
    border-color: #3498db;
}

.sort-select:focus {
    outline: none;
    border-color: #3498db;
}

/* 일괄 작업 버튼 */
.bulk-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-outline {
    padding: 0.5rem 1.5rem;
    background: white;
    color: #3498db;
    border: 2px solid #3498db;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.2s ease;
}

.btn-outline:not(:disabled):hover {
    background: #3498db;
    color: white;
}

.btn-outline:disabled {
    border-color: #ccc;
    color: #ccc;
    cursor: not-allowed;
}

/* 노트 아이템 래퍼 */
.note-item-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

/* 체크박스 스타일 */
.note-checkbox {
    width: 24px;
    height: 24px;
    cursor: pointer;
    flex-shrink: 0;
    margin-left: 0.5rem;
}

.note-item {
    flex: 1;
    text-decoration: none;
    color: inherit;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-content h2 {
    margin-top: 0;
    color: #333;
}

.modal-buttons {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
    justify-content: flex-end;
    align-items: center;
}

.btn-danger {
    background: #ff4444;
    color: white;
    border: none;
    padding: 0.5rem 1.5rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
}

.btn-danger:hover {
    background: #cc0000;
}

/* 모달 내부 버튼 스타일 (style.css override) */
.modal .btn-secondary {
    background: #666;
    color: white;
    border: none;
    padding: 0;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    width: 80px;
    height: 48px;
    box-sizing: border-box;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.modal .btn-secondary:hover {
    background: #444;
}

.modal .btn-primary {
    background: #3498db;
    color: white;
    border: none;
    padding: 0;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    width: 80px;
    height: 48px;
    box-sizing: border-box;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.modal .btn-primary:hover {
    background: #2980b9;
}

.share-email-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    margin: 1rem 0;
    box-sizing: border-box;
}

.share-email-input:focus {
    outline: none;
    border-color: #3498db;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// === 정렬 기능 ===
const sortSelect = document.getElementById('sort-select');
const notesList = document.querySelector('.notes-list');

// 저장된 정렬 설정 불러오기
const savedSort = localStorage.getItem('notes-sort');
if (savedSort) {
    sortSelect.value = savedSort;
    sortNotes(savedSort);
}

// 정렬 변경 이벤트
sortSelect.addEventListener('change', (e) => {
    const sortValue = e.target.value;
    localStorage.setItem('notes-sort', sortValue);
    sortNotes(sortValue);
});

function sortNotes(sortType) {
    // note-item-wrapper들을 배열로 변환
    const noteWrappers = Array.from(document.querySelectorAll('.note-item-wrapper'));

    if (noteWrappers.length === 0) {
        console.log('정렬할 노트가 없습니다.');
        return;
    }

    console.log(`정렬 시작: ${sortType}, 노트 수: ${noteWrappers.length}`);

    // 정렬 수행
    noteWrappers.sort((a, b) => {
        const titleElementA = a.querySelector('.note-item-title');
        const titleElementB = b.querySelector('.note-item-title');
        const dateElementA = a.querySelector('.note-item-date');
        const dateElementB = b.querySelector('.note-item-date');

        if (!titleElementA || !titleElementB || !dateElementA || !dateElementB) {
            console.warn('정렬 중 요소를 찾을 수 없습니다.');
            return 0;
        }

        const titleA = titleElementA.textContent.trim();
        const titleB = titleElementB.textContent.trim();
        const dateA = dateElementA.textContent.trim();
        const dateB = dateElementB.textContent.trim();

        let result = 0;

        switch (sortType) {
            case 'date-desc': // 날짜 최신순 (기본)
                result = dateB.localeCompare(dateA);
                break;

            case 'date-asc': // 날짜 오래된순
                result = dateA.localeCompare(dateB);
                break;

            case 'title-asc': // 제목 가나다순
                result = titleA.localeCompare(titleB, 'ko');
                break;

            case 'title-desc': // 제목 가나다 역순
                result = titleB.localeCompare(titleA, 'ko');
                break;

            default:
                result = 0;
        }

        return result;
    });

    // DOM에 재배치
    noteWrappers.forEach(wrapper => {
        notesList.appendChild(wrapper);
    });

    console.log('정렬 완료');
}

// === 체크박스 및 일괄 작업 관리 ===
const checkboxes = document.querySelectorAll('.note-checkbox');
const selectAllBtn = document.getElementById('select-all-btn');
const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
const shareBtn = document.getElementById('share-btn');

// 체크박스 상태 변경 시 버튼 활성화/비활성화
function updateBulkActionButtons() {
    const checkedBoxes = document.querySelectorAll('.note-checkbox:checked');
    const allChecked = checkboxes.length > 0 && checkedBoxes.length === checkboxes.length;

    // 하나라도 체크되면 버튼 활성화
    if (checkedBoxes.length > 0) {
        selectAllBtn.disabled = false;
        bulkDeleteBtn.disabled = false;
        shareBtn.disabled = false;
    } else {
        selectAllBtn.disabled = true;
        bulkDeleteBtn.disabled = true;
        shareBtn.disabled = true;
    }

    // "모두선택" 버튼 텍스트 변경
    if (allChecked) {
        selectAllBtn.textContent = '선택해제';
    } else {
        selectAllBtn.textContent = '모두선택';
    }
}

// 체크박스 클릭 이벤트
checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateBulkActionButtons);
});

// "모두선택" 버튼 클릭
if (selectAllBtn) {
    selectAllBtn.addEventListener('click', () => {
        const allChecked = document.querySelectorAll('.note-checkbox:checked').length === checkboxes.length;

        checkboxes.forEach(checkbox => {
            checkbox.checked = !allChecked;
        });

        updateBulkActionButtons();
    });
}

// "삭제" 버튼 클릭 (일괄 삭제 모달 표시)
if (bulkDeleteBtn) {
    bulkDeleteBtn.addEventListener('click', () => {
        const checkedBoxes = document.querySelectorAll('.note-checkbox:checked');

        if (checkedBoxes.length === 0) return;

        const modal = document.getElementById('delete-modal');
        const message = document.getElementById('delete-message');

        message.textContent = `선택한 ${checkedBoxes.length}개의 노트를 정말로 삭제하시겠습니까?`;
        modal.style.display = 'flex';
    });
}

// "예" 버튼 클릭 (일괄 삭제 수행)
document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
    const checkedBoxes = document.querySelectorAll('.note-checkbox:checked');

    if (checkedBoxes.length === 0) return;

    const totalCount = checkedBoxes.length;
    let successCount = 0;
    let failCount = 0;

    closeModal();

    // 진행 상황 표시
    console.log(`${totalCount}개의 노트를 삭제하는 중...`);

    // 순차적으로 삭제
    for (let i = 0; i < checkedBoxes.length; i++) {
        const checkbox = checkedBoxes[i];
        const meetingId = checkbox.dataset.meetingId;
        const audioFile = checkbox.dataset.audioFile;

        try {
            const response = await fetch(`/api/delete_meeting/${meetingId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    audio_file: audioFile
                })
            });

            const data = await response.json();

            if (data.success) {
                successCount++;
                console.log(`✅ ${i + 1}/${totalCount} 삭제 완료`);
            } else {
                failCount++;
                console.error(`❌ ${i + 1}/${totalCount} 삭제 실패: ${data.error}`);
            }
        } catch (error) {
            failCount++;
            console.error(`❌ ${i + 1}/${totalCount} 요청 오류:`, error);
        }
    }

    // 결과 알림
    if (failCount === 0) {
        alert(`${successCount}개의 노트가 성공적으로 삭제되었습니다.`);
    } else {
        alert(`${successCount}개 성공, ${failCount}개 실패`);
    }

    // 페이지 새로고침
    window.location.reload();
});

document.getElementById('cancel-delete-btn').addEventListener('click', closeModal);

function closeModal() {
    const modal = document.getElementById('delete-modal');
    modal.style.display = 'none';
}

// 모달 배경 클릭 시 닫기
document.getElementById('delete-modal').addEventListener('click', (e) => {
    if (e.target.id === 'delete-modal') {
        closeModal();
    }
});

// === 공유 기능 ===
// "공유" 버튼 클릭 (공유 모달 표시)
if (shareBtn) {
    shareBtn.addEventListener('click', () => {
        const checkedBoxes = document.querySelectorAll('.note-checkbox:checked');

        if (checkedBoxes.length === 0) return;

        const shareModal = document.getElementById('share-modal');
        const shareMessage = document.getElementById('share-message');
        const shareEmailInput = document.getElementById('share-email-input');

        shareMessage.textContent = `선택한 ${checkedBoxes.length}개의 노트를 공유할 이메일을 입력하세요.`;
        shareEmailInput.value = ''; // 이메일 입력 필드 초기화
        shareModal.style.display = 'flex';
    });
}

// "공유" 확인 버튼 클릭 (공유 수행)
document.getElementById('confirm-share-btn').addEventListener('click', async () => {
    const checkedBoxes = document.querySelectorAll('.note-checkbox:checked');
    const emailInput = document.getElementById('share-email-input');
    const email = emailInput.value.trim();

    if (checkedBoxes.length === 0) return;

    // 이메일 유효성 검사
    if (!email) {
        alert('이메일을 입력해주세요.');
        return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        alert('올바른 이메일 형식을 입력해주세요.');
        return;
    }

    const totalCount = checkedBoxes.length;
    let successCount = 0;
    let failCount = 0;
    const errors = [];

    closeShareModal();

    // 진행 상황 표시
    console.log(`${totalCount}개의 노트를 ${email}에게 공유하는 중...`);

    // 순차적으로 공유
    for (let i = 0; i < checkedBoxes.length; i++) {
        const checkbox = checkedBoxes[i];
        const meetingId = checkbox.dataset.meetingId;
        const title = checkbox.dataset.title;

        try {
            const response = await fetch(`/api/share/${meetingId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email
                })
            });

            const data = await response.json();

            if (data.success) {
                successCount++;
                console.log(`✅ ${i + 1}/${totalCount} 공유 완료: ${title}`);
            } else {
                failCount++;
                errors.push(`${title}: ${data.message || data.error || '알 수 없는 오류'}`);
                console.error(`❌ ${i + 1}/${totalCount} 공유 실패: ${data.message || data.error}`);
            }
        } catch (error) {
            failCount++;
            errors.push(`${title}: 네트워크 오류`);
            console.error(`❌ ${i + 1}/${totalCount} 요청 오류:`, error);
        }
    }

    // 결과 알림
    if (failCount === 0) {
        alert(`${successCount}개의 노트가 ${email}에게 성공적으로 공유되었습니다.`);
    } else {
        let errorMessage = `${successCount}개 성공, ${failCount}개 실패\n\n실패 목록:\n`;
        errorMessage += errors.join('\n');
        alert(errorMessage);
    }

    // 페이지 새로고침
    window.location.reload();
});

// "취소" 버튼 클릭
document.getElementById('cancel-share-btn').addEventListener('click', closeShareModal);

function closeShareModal() {
    const shareModal = document.getElementById('share-modal');
    shareModal.style.display = 'none';
}

// 공유 모달 배경 클릭 시 닫기
document.getElementById('share-modal').addEventListener('click', (e) => {
    if (e.target.id === 'share-modal') {
        closeShareModal();
    }
});
</script>
{% endblock %}
