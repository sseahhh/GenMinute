{% extends "layout.html" %}

{% block title %}요약 생성 테스트{% endblock %}

{% block content %}
<main class="content-panel">
    <header class="content-header">
        <h1>요약 생성 테스트</h1>
        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">텍스트/STT → 요약 → 마인드맵</p>
    </header>

    <div style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
        <!-- 이전 단계 알림 -->
        <div id="previous-step-notice" style="display: none; padding: 1rem; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; margin-bottom: 1.5rem; color: #155724;">
            <strong>✅ 이전 단계 데이터 자동 로드됨</strong>
            <span id="previous-step-text"></span>
        </div>
        <!-- 예시 선택 -->
        <div class="form-group">
            <label for="example-select">예시 선택 (선택하면 자동으로 입력됩니다)</label>
            <select id="example-select" class="form-select" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
                <option value="">직접 입력</option>
                <option value="example1">예시 1: 제품 기획 회의 (AI 챗봇 기능)</option>
                <option value="example2">예시 2: 마케팅 전략 회의 (Q4 캠페인)</option>
                <option value="example3">예시 3: 기술 검토 회의 (시스템 아키텍처)</option>
                <option value="example4">예시 4: 프로젝트 회고 (스프린트 리뷰)</option>
                <option value="example5">예시 5: 예산 배정 회의 (2024년 계획)</option>
            </select>
        </div>

        <!-- 텍스트 입력 -->
        <div class="form-group" style="margin-top: 1.5rem;">
            <label for="input-text">회의록 텍스트</label>
            <textarea id="input-text" rows="20" placeholder="회의 내용을 입력하세요...&#10;&#10;형식 예시:&#10;Speaker 1: 안녕하세요.&#10;Speaker 2: 네, 반갑습니다." style="width: 100%; padding: 1rem; border: 2px solid #ddd; border-radius: 8px; font-family: 'Pretendard', -apple-system, sans-serif; font-size: 0.95rem; line-height: 1.6; resize: vertical;"></textarea>
        </div>

        <!-- 버튼 -->
        <div style="margin-top: 1.5rem; text-align: center;">
            <button id="generate-btn" class="btn-primary" style="padding: 0.75rem 3rem; font-size: 1rem;">요약 생성</button>
        </div>

        <!-- 결과 -->
        <div id="result-section" style="margin-top: 3rem; display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 style="margin: 0;">생성된 요약</h2>
                <button id="copy-btn" class="btn-secondary" style="padding: 0.5rem 1.5rem;">복사</button>
            </div>
            <div id="result-content" style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 2rem; white-space: pre-wrap; font-family: 'Pretendard', -apple-system, sans-serif; line-height: 1.8;"></div>

            <!-- 다음 단계 버튼 -->
            <div style="margin-top: 1.5rem; text-align: center; padding: 1.5rem; background: #e3f2fd; border-radius: 8px;">
                <p style="margin: 0 0 1rem 0; font-weight: 600; color: #1976d2;">✅ 요약 생성 완료! 다음 단계로 이동하세요</p>
                <button id="next-minutes-btn" class="btn-primary" style="padding: 0.75rem 3rem; font-size: 1rem;">회의록 생성하기 →</button>
            </div>
        </div>

        <!-- 로딩 -->
        <div id="loading-section" style="margin-top: 3rem; text-align: center; display: none;">
            <div class="spinner" style="margin: 2rem auto; width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="color: #666; font-size: 1.1rem;">요약을 생성하고 있습니다...</p>
        </div>
    </div>
</main>

<script>
// 페이지 로드 시 이전 단계 데이터 자동 로드
window.addEventListener('DOMContentLoaded', () => {
    const previousData = sessionStorage.getItem('pipeline_stt_result');
    const previousStep = sessionStorage.getItem('pipeline_step');

    if (previousData && previousStep === 'stt') {
        document.getElementById('input-text').value = previousData;
        document.getElementById('previous-step-notice').style.display = 'block';
        document.getElementById('previous-step-text').textContent = ' (STT 결과)';
        console.log('✅ 이전 단계 데이터 자동 로드 완료');
    }
});

// 예시 텍스트 데이터
const exampleTexts = {
    "example1": `Speaker 1: 안녕하세요. 오늘은 신규 모바일 앱에 AI 챗봇 기능을 추가하는 건에 대해 논의하겠습니다.
Speaker 2: 네, 좋습니다. 현재 사용자들이 FAQ를 많이 찾아보고 있어서 챗봇이 필요할 것 같습니다.
Speaker 1: 맞습니다. 저희가 조사한 바로는 월 평균 1만 건의 FAQ 조회가 발생하고 있어요. 챗봇으로 이걸 자동화하면 고객센터 부담도 줄고 사용자 만족도도 올라갈 것 같습니다.
Speaker 3: 기술적으로는 어떤 모델을 사용할 예정인가요?
Speaker 1: GPT-4를 우선 고려하고 있습니다. 비용은 좀 높지만 응답 품질이 우수해서요.
Speaker 2: 비용이 얼마나 예상되나요?
Speaker 1: 월 사용자 수를 고려하면 대략 월 200만원 정도 예상됩니다.
Speaker 3: 조금 부담스러운데, Claude나 Gemini도 검토해보는 게 어떨까요? 성능은 비슷한데 비용이 더 저렴할 수 있습니다.
Speaker 1: 좋은 제안입니다. 3개 모델을 모두 테스트해보고 비용 대비 성능을 비교해보겠습니다.
Speaker 2: 일정은 어떻게 되나요?
Speaker 1: 이번 주에 프로토타입을 만들고, 다음 주에 내부 테스트, 그 다음 주에 베타 오픈을 목표로 하고 있습니다.
Speaker 3: 데이터 보안은 어떻게 처리하나요? 사용자 질문이 외부 API로 전송되잖아요.
Speaker 1: 개인정보가 포함된 질문은 필터링하고, 모든 데이터는 암호화해서 전송할 예정입니다.
Speaker 2: 알겠습니다. 그럼 다음 회의 때 프로토타입 데모를 보여주시면 좋겠습니다.`,

    "example2": `Speaker 1: Q4 마케팅 캠페인 계획에 대해 논의하겠습니다. 목표는 신규 가입자 3만 명 확보입니다.
Speaker 2: 예산은 얼마나 배정되었나요?
Speaker 1: 총 5천만원입니다. SNS 광고에 3천, 인플루언서 마케팅에 2천만원을 사용할 예정입니다.
Speaker 3: 어떤 플랫폼을 타겟으로 하나요?
Speaker 1: 인스타그램과 유튜브를 메인으로 하고, 틱톡도 테스트해볼 계획입니다.
Speaker 2: 인플루언서는 누구를 섭외하나요?
Speaker 1: 구독자 10만~50만 사이의 마이크로 인플루언서 10명 정도 접촉 중입니다. 대형 인플루언서보다 비용 대비 효과가 좋습니다.
Speaker 3: 캠페인 메시지는 어떻게 가져갈 건가요?
Speaker 1: "AI로 회의록 자동 작성"이라는 핵심 가치를 강조하고, 실제 사용 사례를 영상으로 보여줄 예정입니다.
Speaker 2: 랜딩 페이지는 준비되었나요?
Speaker 1: 이번 주 금요일까지 완성 예정입니다. A/B 테스트도 준비 중입니다.
Speaker 3: 전환율 목표는 얼마인가요?
Speaker 1: 광고 클릭 후 가입 전환율 5%를 목표로 하고 있습니다.
Speaker 2: KPI는 어떻게 추적하나요?
Speaker 1: Google Analytics와 자체 대시보드를 통해 일별로 모니터링합니다. 주간 리포트도 공유할 예정입니다.`,

    "example3": `Speaker 1: 시스템 아키텍처 개선에 대해 논의하겠습니다. 현재 모놀리식 구조의 한계가 명확해지고 있어서 마이크로서비스로 전환을 검토 중입니다.
Speaker 2: 구체적으로 어떤 문제가 있나요?
Speaker 1: 배포 시간이 너무 오래 걸리고, 한 부분에 문제가 생기면 전체 시스템이 영향을 받습니다. 또한 팀별로 독립적인 개발이 어렵습니다.
Speaker 3: 마이크로서비스로 전환하면 복잡도가 증가하지 않나요?
Speaker 1: 맞습니다. 하지만 Kubernetes와 Istio를 활용하면 관리가 수월해집니다. 이미 DevOps 팀에서 준비 중입니다.
Speaker 2: 데이터베이스는 어떻게 할 건가요?
Speaker 1: 각 서비스마다 독립적인 DB를 사용하고, 데이터 동기화가 필요한 부분은 이벤트 기반으로 처리할 계획입니다.
Speaker 3: 성능 저하는 없을까요?
Speaker 1: 초기에는 네트워크 오버헤드로 약간의 지연이 있을 수 있지만, 캐싱과 로드 밸런싱으로 최적화할 예정입니다.
Speaker 2: 마이그레이션 일정은요?
Speaker 1: 3개월로 잡고 있습니다. 먼저 인증 서비스부터 분리하고, 순차적으로 다른 모듈들도 전환할 계획입니다.
Speaker 3: 테스트는 어떻게 할 건가요?
Speaker 1: 각 서비스별로 단위 테스트를 강화하고, 통합 테스트는 컨테이너 환경에서 자동화할 예정입니다.`,

    "example4": `Speaker 1: 스프린트 3 회고를 시작하겠습니다. 먼저 잘된 점부터 공유해볼까요?
Speaker 2: 이번에 코드 리뷰 프로세스를 개선한 게 정말 좋았습니다. 버그가 배포 전에 많이 잡혔어요.
Speaker 3: 맞아요. PR 템플릿을 도입한 것도 좋았습니다. 리뷰어가 뭘 봐야 할지 명확해졌어요.
Speaker 1: 좋습니다. 그럼 개선이 필요한 점은 무엇이 있을까요?
Speaker 2: 스프린트 중간에 요구사항이 자주 변경되어서 일정 관리가 어려웠습니다.
Speaker 3: 저도 동감합니다. 기획팀과 더 자주 소통해서 변경사항을 미리 파악하면 좋을 것 같아요.
Speaker 1: 알겠습니다. 다음 스프린트부터는 일일 스탠드업에 기획팀도 참여하도록 하겠습니다.
Speaker 2: 테스트 커버리지도 조금 부족했던 것 같아요. 목표가 80%였는데 65%밖에 달성하지 못했습니다.
Speaker 3: 시간이 부족해서 그랬는데, 다음에는 개발과 동시에 테스트 코드를 작성하는 TDD 방식을 시도해보면 어떨까요?
Speaker 1: 좋은 제안입니다. 다음 스프린트 목표에 반영하겠습니다. 이번 스프린트에서 가장 뿌듯했던 순간은 언제였나요?
Speaker 2: 저는 성능 최적화 작업이 성공해서 페이지 로딩 시간이 절반으로 줄었을 때 정말 뿌듯했습니다.
Speaker 3: 저는 신규 기능이 출시되고 사용자들의 긍정적인 피드백을 받았을 때 보람을 느꼈습니다.`,

    "example5": `Speaker 1: 2024년 예산 배정 회의를 시작하겠습니다. 각 부서별로 요청사항을 공유해주세요.
Speaker 2: 개발팀은 총 2억원을 요청합니다. 서버 인프라 확장에 1억, 개발 도구 라이선스에 5천만원, 교육 및 컨퍼런스 참가비로 5천만원이 필요합니다.
Speaker 3: 마케팅팀은 1억 5천만원을 요청합니다. 광고비로 1억, 이벤트 및 프로모션으로 5천만원입니다.
Speaker 1: 인사팀은 어떤가요?
Speaker 4: 5천만원을 요청합니다. 채용 비용으로 3천만원, 복리후생 개선에 2천만원입니다.
Speaker 1: 총 4억원이 요청되었는데, 현재 배정 가능한 예산은 3억원입니다. 우선순위를 논의해야겠습니다.
Speaker 2: 서버 인프라는 현재 사용률이 90%를 넘어서 확장이 시급합니다. 이건 꼭 필요합니다.
Speaker 3: 마케팅 예산도 중요합니다. 신규 고객 유입이 없으면 매출 성장이 어렵습니다.
Speaker 1: 두 가지 모두 중요하네요. 개발팀 교육비는 다음 분기로 미룰 수 있을까요?
Speaker 2: 네, 그렇게 하면 1억 5천만원으로 조정 가능합니다.
Speaker 3: 마케팅팀도 이벤트 예산을 줄여서 1억 2천만원으로 맞추겠습니다.
Speaker 1: 그럼 개발팀 1억 5천, 마케팅팀 1억 2천, 인사팀 3천으로 총 3억을 배정하겠습니다. 동의하시나요?
Speaker 2: 네, 동의합니다.
Speaker 3: 저도 동의합니다.`
};

// 예시 선택 시 텍스트 자동 입력
document.getElementById('example-select').addEventListener('change', (e) => {
    const selectedKey = e.target.value;
    const textarea = document.getElementById('input-text');

    if (selectedKey && exampleTexts[selectedKey]) {
        textarea.value = exampleTexts[selectedKey];
    } else {
        textarea.value = '';
    }
});

// 요약 생성 버튼
document.getElementById('generate-btn').addEventListener('click', async () => {
    const text = document.getElementById('input-text').value.trim();

    if (!text) {
        alert('텍스트를 입력해주세요.');
        return;
    }

    // 로딩 표시
    document.getElementById('result-section').style.display = 'none';
    document.getElementById('loading-section').style.display = 'block';

    try {
        const response = await fetch('/api/test_summary', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: text,
                title: '테스트 회의'
            })
        });

        const data = await response.json();

        if (data.success) {
            // 결과 표시
            document.getElementById('result-content').textContent = data.summary;
            document.getElementById('result-section').style.display = 'block';

            // sessionStorage에 저장 (다음 단계로 전달)
            sessionStorage.setItem('pipeline_summary_result', data.summary);
            sessionStorage.setItem('pipeline_step', 'summary');

            console.log('✅ 요약 결과 저장:', data.summary.substring(0, 100) + '...');
        } else {
            alert('요약 생성 실패: ' + (data.error || '알 수 없는 오류'));
        }
    } catch (error) {
        console.error('요약 생성 오류:', error);
        alert('요약 생성 중 오류가 발생했습니다.');
    } finally {
        document.getElementById('loading-section').style.display = 'none';
    }
});

// 복사 버튼
document.getElementById('copy-btn').addEventListener('click', () => {
    const content = document.getElementById('result-content').textContent;
    navigator.clipboard.writeText(content).then(() => {
        alert('복사되었습니다!');
    }).catch(err => {
        console.error('복사 실패:', err);
        alert('복사에 실패했습니다.');
    });
});

// 다음 단계 (회의록) 버튼
document.getElementById('next-minutes-btn').addEventListener('click', () => {
    window.location.href = '/test-minutes';
});
</script>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
}
</style>
{% endblock %}
